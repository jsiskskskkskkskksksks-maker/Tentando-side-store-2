name: Build LuminaSigner IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout do Código
      uses: actions/checkout@v4

    - name: Configurar Theos
      run: |
        sudo git clone --recursive https://github.com/theos/theos.git ~/theos
        echo "THEOS=~/theos" >> $GITHUB_ENV

    - name: Baixar SDK do iOS
      run: |
        git clone https://github.com/theos/sdks.git ~/theos/sdks
        # Usando o SDK 14.5 para máxima compatibilidade com iPad
        
    - name: Compilar Aplicativo
      run: |
        export THEOS=~/theos
        make clean
        make package FINALPACKAGE=1
      
    - name: Preparar IPA para ESign
      run: |
        mkdir -p Payload
        # O Theos gera o app na pasta .theos/obj/install/
        # Vamos mover o .app para a pasta Payload e zipar como .ipa
        cp -r .theos/obj/debug/*.app Payload/ 2>/dev/null || cp -r .theos/obj/*.app Payload/
        zip -r LuminaSigner.ipa Payload
        
    - name: Salvar Instalador (.ipa)
      uses: actions/upload-artifact@v4
      with:
        name: LuminaSigner-App
        path: LuminaSigner.ipa
